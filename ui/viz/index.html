<!DOCTYPE html>
<html>
<head>
  <titLe>SEPTA OnTime Routes</title>
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript"
	  src="http://maps.google.com/maps/api/js?sensor=false">
  </script>
  <script src="js/highcharts.js" type="text/javascript"></script>
  <link href="main.css" rel="stylesheet" type="text/css"></link>

  <script>
    var baseURL = "http://appdev.adamhinz.com:8080/"

/**
 * Create a new grapah by execute an async ajax request to
 * load historic data from the web services
 *
 * Parameter elements:
 * @param element string element to render to
 * @param start,end  start and end times to render (decimal hours)
 * @param offset how much data to look backwards at (decimal hours)
 * @param incr the amount to increment each model (decimal hours)
 * @param date Date object specifying the date to run the model with
 * @param startStation the id of the starting station
 * @param startStationName the name of the starting station
 * @param endStation the id of the ending station
 * @param endStationName the name of the ending station
 * @param direction the direction
 */
function createGraph(params) {

    var startdate = params.date.getTime();
    var enddate = startdate + 1000*60*60*25;
    var n = (params.end - params.start)/params.incr;

    $.ajax({
	url: baseURL + "station/" + params.startStation + 
	    "/to/" + params.endStation + "/" + params.direction + "?endDate=" + enddate +
	    "&startDate=" + startdate + "&startTime=" + params.start + "&endTime=" + 
	    (params.start+params.offset) + "&" + "seriesTimeIncrement=" + params.incr + 
	    "&numberOfRuns=" + n,
	dataType: 'jsonp',
	timeout: 1000*60,
	success: function( content ) {
	    var data = [];
	    var count = 0;
	    for(var i=params.start;i<params.end;i+=params.incr) {
		// Cheat right now
//		if (content[count] > 15) {
		    data.push([i + params.offset, content[count]]);
//		}
		count += 1;
	    }
	    
	    renderChart(data, 
			"Time to " + params.startStationName + 
			" to " + params.endStationName,
			params.element);
	}
    });
}

/**
 * Render the data into a chart in the given container
 *
 * @param array of pairs to render
 * @param title the title of the chart
 * @param container a string id of the container to render to
 */
function renderChart( data, title, container ) {
    chart1 = new Highcharts.Chart({
	chart: {
	    renderTo: container,
	    defaultSeriesType: 'spline'
	},
	title: {
	    text: title
	},
	xAxis: {
	    //categories: $.map(data, function ( datum ) { return datum[0]; }),
	    plotBands: [{ 
		from: 7.5,
		to: 9.5,
		color: 'rgba(68, 170, 213, 0.1)',
		label: {
		    text: 'Morning Rush',
		    style: {
			color: '#606060'
		    }
		}
            },{
		from: 16.0,
		to: 19.0,
		color: 'rgba(68, 170, 213, 0.1)',
		label: {
		    text: 'Afternoon Rush',
		    style: {
			color: '#606060'
		    }
		}
	    }]
	},
	tooltip: {
	    formatter: function() {
		return '<b>'+ this.series.name +'</b><br/>'+
		    this.x  +': '+ this.y;
	    }
	},
	series: [{
	    name: 'Route Time',
	    data: data 
	}]
    });
}

/**
 * Perform an async AJAX call to determine the bus route between two
 * lat/lon pts.
 *
 * @param lat1,lon1     First point
 * @param lat2,lon2     Second point
 * @param route         Route to draw
 * @param map           Map to draw on
 * @param bounds        Current map bounds
 * @param busLines      List of current lines representing the route on the map
 *
 * @mutates bound       Upon ajax async return bounds will include this line
 * @mutates busLines    Upon ajax async return this array will contain a ref to the bus
 */
function drawLine(lat1,lon1,lat2,lon2,route,map,bounds,busLines,color) {
    $.ajax({
	url: baseURL + "map/" + route + "/" + lat1 + "," + lon1 + "/to/" + lat2 + "," + lon2 + "/",
	dataType: 'jsonp',
	success: function( points ) {
	    busLines.push(
		new google.maps.Polyline({
		    path: points.map(function( point ) {
			var ll = new google.maps.LatLng(point.lat, point.lon);
			if (bounds == null) {
			    bounds = new google.maps.LatLngBounds(ll,ll);
			} else {
			    bounds = bounds.extend(ll);
			}
			
			return ll;
		    }),
		    map: map,
		    strokeColor: color || "#FF0000",
		    strokeOpacity: 1.0,
		    strokeWeight: 2
		}));

		map.fitBounds(bounds);
	    }
	});
}

/**
 * Completely render the results table
 *
 * @param table String id of the table to render to
 * @param busses array of bus est objects
 * @param timeToDest (Optional) time offset to destination
 */
function renderTable(table, busses, timeToDest) {
    $("#" + table + " tr").map(function( index, dom ) {
	if (index > 0) {
	    alert(index);
	    $(dom).remove();
	}
    });

    var table = $("#" + table);
    busses.map(function( bus ) {
	table.append(createResultRow(bus, timeToDest));
    });

    if ((busses == null || busses.length == 0) && typeof timeToDest !== "undefined") {
	table.append("<tr><td colspan=\"4\">Estimate time to arrival: " + timeToDest + "</td></tr>");
    }
}

function createResultRow(busest, timeToDest) {
    var timeStr = ""
    if(typeof timeToDest !== "undefined") {
	timeStr = timeToDest;
    }

    return "<tr class=\"result\"><td>" + busest.busId + "</td>" +
	"<td>" + busest.blockId + "</td>" +
	"<td>" + busest.arrival[0] + "</td>" + 
	"<td>" + timeStr + "</td></tr>";
}

    $(function() {
	var latlng = new google.maps.LatLng(39.9522222, -75.1641667);
	var myOptions = {
	    zoom: 12,
	    center: latlng,
	    mapTypeId: google.maps.MapTypeId.ROADMAP
	};
	var map = new google.maps.Map(document.getElementById("map"),
				  myOptions);	

	var bounds = null;
	var busLines = [];

	// Load route data
	$.ajax({
	    url: baseURL + "routes/",
	    dataType: 'jsonp',
	    success: function( routes ) {
		var routeSelect = $("#route")
		routeSelect.attr("disabled",false);
		routes.map(function( route ) {
		    routeSelect.append("<option>" + route + "</option>");
		});
	    }
	});

	var selectedRoute = null;
	var selectedDirection = null;
	var stationId = null;
	var toStationId = null;
	var stationLatLons = {};
	var mostRecentEsts = null;

	$("#route").change(function() {
	    selectedRoute = $(this).val();
	    var dirSel = $("#dir");
	    $.ajax({
		url: baseURL + "routes/" + selectedRoute,
		dataType: 'jsonp',
		success: function( directions ) {
		    directions.map(function( direction ) {
			dirSel
			    .attr("disabled", false)
			    .append($("<option value=\"" + direction.directionID + "\">" + direction.name + "</option>"))
		    });
		}
	    });
	});

	$("#dir").change(function() {
	    selectedDirection = $(this).val();
	    var stationSel = $("#station_from");
	    var stationToSel = $("#station_to");
	    $.ajax({
		url: baseURL + "routes/" + selectedRoute + "/" + selectedDirection,
		dataType: 'jsonp',
		success: function( stations ) {
		    stations.map(function( station ) {
			stationLatLons[station.id] = new google.maps.LatLng(station.lat,station.lon);
			stationSel
			    .attr("disabled", false)
			    .append($("<option></option>")
				    .attr("value", station.id)
				    .text(station.name));
			stationToSel
			    .append($("<option></option>")
				    .attr("value", station.id)
				    .text(station.name));
		    });
		}
	    });
	});

	// Example bus output data:
	// {"blockId":"9677","busId":"8164",
	// "bus":{"lat":40.008308,"lon":-75.251572},
	// "station":{"lat":40.004973,"lon":-75.217954},
	// "origOffset":1.0,
	// "offset":4.433193086102814,
	// "arrival":[8.622357188158317] }
	$("#station_from").change(function() {
	    $("#placeholder").html("Loading estimates...");
	    stationId = $(this).val();
	    
	    stationLatLon = stationLatLons[stationId];
	    new google.maps.Marker({
		position: stationLatLon,
		map: map
	    });

	    bounds = new google.maps.LatLngBounds(stationLatLon,stationLatLon);

	    $.ajax({
		url: baseURL + "station/" + stationId + "/bus/" + selectedRoute + "/" + selectedDirection,
		dataType: 'jsonp',
		success: function( estimates ) {
		    $("#station_to").attr("disabled", false);

		    mostRecentEsts = estimates;
		    $("#placeholder").remove();

		    var table = $("#est");

		    renderTable("est", mostRecentEsts);

		    estimates.map(function( estimate ) {
			new google.maps.Marker({
			    position: new google.maps.LatLng(estimate.bus.lat, estimate.bus.lon),
			    map: map,
			    icon: "http://www3.septa.org/transitview/images/bus_blue.png"
			});

			drawLine(stationLatLon.lat(), stationLatLon.lng(),
				 estimate.bus.lat, estimate.bus.lon,
				 selectedRoute, map, bounds, busLines, "#F00");
		    });
		}
	    });
	});
	
	$("#station_to").change(function() {

	    toStationId = $(this).val();

	    var toStationLatLon = stationLatLons[toStationId];

	    new google.maps.Marker({
		position: toStationLatLon,
		map: map
	    });

	    drawLine(stationLatLon.lat(), stationLatLon.lng(),
		     toStationLatLon.lat(), toStationLatLon.lng(),
		     selectedRoute, map, bounds, busLines, "#00F");

	    $.ajax({
		url: baseURL + "station/" + stationId + "/to/" + toStationId + "/" + selectedDirection,
		dataType: 'jsonp',
		success: function( estimates ) {
		    renderTable("est", mostRecentEsts, estimates[0]);
		}
	    });
	});

	$("#historic").click(function( button ) {
	    $("#historic_content").css("display","block");
	    var start = 4.0;
	    var offset = 2.0;
	    var incr = .25;
	    var end = 20.0;

	    var name = "Ignore";

	    createGraph({
		element: 'history_graph',
		start: start,
		end: end,
		offset: offset,
		incr: incr,
		date: new Date(2011,5,22),
		startStation: stationId,
		startStationName: name,
		endStation: toStationId,
		endStationName: name,
		direction: selectedDirection
	    });

	});

	$(".close").click(function( button ) {
	    $(".overlay_content").css("display","none");
	});
 });
  </Script>
</head>
<body>
<div id="historic_content" class="overlay_content">
  <a href="#" class="close">Close</a>
  <div id="history_graph"></div>
</div>
<div id="content">
  <div id="selects" style="float:left;position: relative;" class="rounded content">
    <div id="title" class="roundedtop borderbottom"><h3>SEPTA Next Bus<h3></div>
    <div class="borderbottom">
      <p>This tool uses the new SEPTA real time bus API to determine when the next bus will arrive at a stop</p><p>To start using the tool just pick your route, direction, and starting station</p><p>Select your destination station to determine route times.</p>
    </div>
    <div class="borderbottom" style="padding-bottom: 20px;">
      <div>
	<p>Select Route & Direction</p>
	<select id="route" disabled>
	  <option id="-1">Routes</option>
	</select>
      </div>
      <div>
	<select id="dir" disabled>
	  <option id="-1">Directions</option>
	</select>
      </div>
      <div>
	<p>Pick starting and ending stations</p>
	<select id="station_from" disabled>
	  <option id="-1">Starting Station</option>
	</select>		 
      </div>
      <div>
	<select id="station_to" disabled>
	  <option id="-1">Arrival Station</option>
	</select>
      </div>
    </div>
    <p>Select start and arrival stations to enable these actions</p>
    <div style="width: 79%">
      <div><a href="#" id="curconds" class="button centering">Current Conditions</a></div>
      <div><a href="#" id="createschd" class="button centering">Create Schedule</a></div>
      <div><a href="#" id="historic" class="button centering">Historic Data</a></div>
    </div>
    <div class="who roundedbottom">Designed by Adam Hinz</div>
  </div>
  <div id="map_container" class="rounded content">
    <div id="map"></div>
    <table id="est">
      <thead>
      <tr>
	<th>Bus #</th><th>Block #</th><th>Departing Station</th><th>Arrive Dst</th>
      </tr>
      </thead>
    </table>
    <p style="color: gray;" id="placeholder">Select stations to the left to display bus times</p>
  </div>
  <div style="clear: both;"></div>
</div>
</body>
